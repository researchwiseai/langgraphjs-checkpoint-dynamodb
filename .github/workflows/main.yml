name: AI Code Reviewer

on:
    pull_request:
        branches:
            - main
    push:
        branches:
            - main
        paths-ignore:
            - '**/*.json'
            - '**/*.md'
permissions: write-all # Needed for AI reviewer
jobs:
    lint:
        runs-on: ubuntu-latest
        name: Lint Code
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
            - name: Setup Environment
              uses: ./.github/actions/setup
              with:
                  node-version: '20'
                  bun-version: 'latest'

            - name: Run linter
              run: bun run lint

    format:
        runs-on: ubuntu-latest
        name: Check Code Formatting
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
            - name: Setup Environment
              uses: ./.github/actions/setup
              with:
                  node-version: '20'
                  bun-version: 'latest'

            - name: Check code formatting
              run: bun run format:check

    build:
        runs-on: ubuntu-latest
        name: Build Project
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
            - name: Setup Environment
              uses: ./.github/actions/setup
              with:
                  node-version: '20'
                  bun-version: 'latest'

            - name: Build the project
              run: bun run build

    test:
        runs-on: ubuntu-latest
        name: Unit Test Project
        steps:
            - name: Checkout code
              uses: actions/checkout@v3
            - name: Setup Environment
              uses: ./.github/actions/setup
              with:
                  node-version: '20'
                  bun-version: 'latest'

            - name: Run tests
              run: bun run test

    review:
        runs-on: ubuntu-latest
        needs: [lint, format, build, test]
        if: github.event_name == 'pull_request'
        steps:
            - name: Checkout Repo
              uses: actions/checkout@v3

            - name: AI Code Reviewer
              uses: freeedcom/ai-codereviewer@v2.7.0
              with:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
                  OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
                  OPENAI_API_MODEL: 'gpt-4'
                  exclude: '**/*.json, **/*.md'

    integration-test:
        runs-on: ubuntu-latest
        name: Integration Test Project
        needs: [lint, format, build, test]
        services:
            dynamodb:
                image: amazon/dynamodb-local
                ports:
                    - 8000:8000
        steps:
            - name: Checkout code
              uses: actions/checkout@v3

            - name: Setup Environment
              uses: ./.github/actions/setup
              with:
                  node-version: '20'
                  bun-version: 'latest'

            - name: Wait for DynamoDB service to be ready
              run: |
                  for i in {1..10}; do
                    if nc -z localhost 8000; then
                      echo "DynamoDB is up!"
                      break
                    fi
                    echo "Waiting for DynamoDB..."
                    sleep 2
                  done
            - name: Run integration tests
              env:
                  AWS_ACCESS_KEY_ID: 'fakeMyKeyId'
                  AWS_SECRET_ACCESS_KEY: 'fakeSecretAccessKey'
                  AWS_REGION: 'local'
                  AWS_DYNAMODB_ENDPOINT: 'http://localhost:8000'
              run: bun run test:integration
